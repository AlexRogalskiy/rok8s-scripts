description: >
  Sets up a working e2e testing environment for Kubernetes using kind and runs an arbitrary script against it.
parameters:
  kind_version:
    description: "The kind version to use. See https://github.com/kubernetes-sigs/kind/releases"
    type: string
    default: "0.4.0"
  kind_node_image:
    description: "The kind node image to use.  See https://github.com/kubernetes-sigs/kind/releases"
    type: string
    default: "kindest/node:v1.13.7@sha256:f3f1cfc2318d1eb88d91253a9c5fa45f6e9121b6b1e65aea6c7ef59f1549aaaf"
  command_runner_image:
    description: "The image to execute commands from against the kind cluster."
    type: string
    default: "quay.io/reactiveops/ci-images:v9.0-alpine"
  pre_script:
    description: "Script to run on the local machine before running on command runner."
    type: string
  script:
    description: "The script to run on the command runner."
    type: string
executor: ci-images
steps:
  - checkout
  - setup_remote_docker
  - set_env
  - e2e_start_kind_cluster:
      kind_node_image: << parameters.kind_node_image >>
      kind_version: << parameters.kind_version >>
  - e2e_start_command_runner:
      command_runner_image: << parameters.command_runner_image >>
  - e2e_helm_init
  - e2e_hostpath_provisioner
  - e2e_run_script:
      pre_script: << parameters.pre_script >>
      script: << parameters.script >>

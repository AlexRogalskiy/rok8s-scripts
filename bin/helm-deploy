#!/bin/bash

#helm-deploy

DEFAULT_REPLICA_COUNT=1
set -eo pipefail

. k8s-read-config
k8s-deploy-secrets


if [[ ! -z $(kubectl get deployments --namespace=${NAMESPACE} -o json | jq -r '.items[].metadata.name' | grep -x ${DEPLOYMENT}) ]]
then
  REPLICA_COUNT=$(kubectl get deployment ${DEPLOYMENT} --namespace=${NAMESPACE} -o json | jq '.status.readyReplicas')
else
  REPLICA_COUNT=${DEFAULT_REPLICA_COUNT}
fi

helm upgrade --install $CHART_NAME  --namespace=$NAMESPACE ./deploy/charts/$CHART_NAME -f deploy/$VALUES_FILE -d replicas=$REPLICA_COUND -d image.tag=$CI_SHA
